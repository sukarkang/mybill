<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PPPoE Billing | Smart Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4361ee',
                        secondary: '#3a0ca3',
                        accent: '#4cc9f0',
                        success: '#06ffa5',
                        warning: '#ffbe0b',
                        danger: '#fb5607',
                        dark: '#1a1a2e',
                        darker: '#16213e'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
        }

        .bg-elegant {
            min-height: 100vh;
            position: fixed;
            width: 100%;
            z-index: -2;
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #172554, #1e3a5f, #0c4a6e, #134e4a, #1e1b4b, #0f172a);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            25% { background-position: 50% 100%; }
            50% { background-position: 100% 50%; }
            75% { background-position: 50% 0%; }
            100% { background-position: 0% 50%; }
        }

        .aurora-overlay {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: linear-gradient(45deg, transparent 40%, rgba(120, 119, 198, 0.05) 45%, transparent 50%),
                        linear-gradient(-45deg, transparent 40%, rgba(255, 119, 198, 0.05) 45%, transparent 50%);
            background-size: 200% 200%;
            animation: aurora 15s ease infinite;
            pointer-events: none;
        }
        
        @keyframes aurora {
            0%, 100% { background-position: 0% 50%, 100% 50%; }
            50% { background-position: 100% 50%, 0% 50%; }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        .dark .glass-card {
            background: rgba(2, 6, 23, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }
        
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
        }

        #overlay {
            transition: opacity 0.3s ease;
            pointer-events: none;
            opacity: 0;
            z-index: 40;
        }
        #overlay.active { pointer-events: auto; opacity: 1; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        input, select, textarea {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #4361ee;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
    </style>
</head>
<body class="text-slate-200">

    <div class="bg-elegant"></div>
    <div class="aurora-overlay"></div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 z-[100] min-w-[250px] px-4 py-3 rounded-xl shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 font-medium text-sm flex items-center gap-3">
        <i id="toast-icon" class="fas"></i>
        <span id="toast-msg">Message</span>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md rounded-3xl p-8 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-primary/20 rounded-full blur-2xl -mr-10 -mt-10"></div>
            <div class="absolute bottom-0 left-0 w-24 h-24 bg-accent/10 rounded-full blur-xl -ml-5 -mb-5"></div>

            <div class="text-center mb-8 relative z-10">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-primary to-secondary mb-4 shadow-lg shadow-primary/30">
                    <div class="flex flex-col items-center text-white">
                        <i class="fas fa-network-wired text-2xl -mb-1"></i>
                        <i class="fas fa-wifi text-xl"></i>
                    </div>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-wide">PPPoE <span class="text-primary font-light">Billing</span></h1>
                <p class="text-slate-400 text-sm mt-1">Multi-User Management System</p>
            </div>

            <form id="login-form" class="space-y-4 relative z-10">
                <div class="group">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Username</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors"></i>
                        <input type="text" id="login-user" class="login-input w-full pl-11 p-3.5 rounded-xl focus:ring-2 ring-primary/50 placeholder-slate-500" placeholder="Masukkan username" required>
                    </div>
                </div>
                <div class="group">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Password</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors"></i>
                        <input type="password" id="login-pass" class="login-input w-full pl-11 p-3.5 rounded-xl focus:ring-2 ring-primary/50 placeholder-slate-500" placeholder="Masukkan password" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-primary to-secondary hover:opacity-90 text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/25 transition-all transform active:scale-95 mt-4">
                    Masuk Sistem
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-[10px] text-slate-500 font-mono">v3.0 â€¢ Multi-User Sync</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-content" class="hidden">
        
        <div id="overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleSidebar()"></div>

        <div class="flex h-screen relative overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar fixed md:relative w-72 h-full glass-card border-r border-white/5 flex flex-col">
                <div class="p-6 border-b border-white/5">
                    <h1 class="text-xl font-bold text-white flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-accent flex items-center justify-center">
                            <i class="fas fa-wifi text-white text-xs"></i>
                        </div>
                        <span>Billing<span class="text-primary">Pro</span></span>
                    </h1>
                    <p class="text-[10px] text-slate-400 font-mono mt-2" id="user-role-display">LOADING...</p>
                    
                    <div class="mt-3 inline-flex items-center gap-2 bg-white/5 rounded-lg px-2 py-1 border border-white/10 w-auto">
                        <div class="flex items-center justify-center w-5 h-5 rounded-full bg-primary/20 text-primary">
                            <i class="fas fa-clock text-[9px] animate-pulse"></i>
                        </div>
                        <div class="flex flex-col leading-tight">
                            <span id="live-clock" class="text-[11px] font-mono font-semibold tracking-[0.2em] text-white">00:00:00</span>
                            <span id="live-date" class="text-[8px] text-slate-400 font-medium">-</span>
                        </div>
                    </div>
                </div>

                <nav class="flex-1 overflow-y-auto p-4 space-y-1">
                    <button onclick="showTab('dashboard')" class="nav-link w-full flex items-center gap-3 p-3 rounded-xl text-slate-300 hover:bg-white/5 hover:text-white transition-all active">
                        <i class="fas fa-th-large w-6 text-center"></i> <span class="font-medium text-sm">Dashboard</span>
                    </button>
                    <button onclick="showTab('transactions')" class="nav-link w-full flex items-center gap-3 p-3 rounded-xl text-slate-300 hover:bg-white/5 hover:text-white transition-all">
                        <i class="fas fa-receipt w-6 text-center"></i> <span class="font-medium text-sm">Transaksi</span>
                    </button>
                    <button onclick="showTab('customers')" class="nav-link w-full flex items-center gap-3 p-3 rounded-xl text-slate-300 hover:bg-white/5 hover:text-white transition-all">
                        <i class="fas fa-users w-6 text-center"></i> <span class="font-medium text-sm">Pelanggan</span>
                    </button>
                    <button onclick="showTab('whatsapp')" class="nav-link w-full flex items-center gap-3 p-3 rounded-xl text-slate-300 hover:bg-white/5 hover:text-white transition-all">
                        <i class="fab fa-whatsapp w-6 text-center"></i> <span class="font-medium text-sm">WhatsApp</span>
                    </button>
                    <button onclick="showTab('reports')" class="nav-link w-full flex items-center gap-3 p-3 rounded-xl text-slate-300 hover:bg-white/5 hover:text-white transition-all">
                        <i class="fas fa-chart-pie w-6 text-center"></i> <span class="font-medium text-sm">Laporan</span>
                    </button>
                    <button onclick="showTab('settings')" class="nav-link w-full flex items-center gap-3 p-3 rounded-xl text-slate-300 hover:bg-white/5 hover:text-white transition-all admin-only" style="display: none;">
                        <i class="fas fa-cog w-6 text-center"></i> <span class="font-medium text-sm">Pengaturan</span>
                    </button>
                    <button onclick="showTab('users')" class="nav-link w-full flex items-center gap-3 p-3 rounded-xl text-slate-300 hover:bg-white/5 hover:text-white transition-all admin-only" style="display: none;">
                        <i class="fas fa-user-cog w-6 text-center"></i> <span class="font-medium text-sm">Kelola User</span>
                    </button>
                </nav>

                <div class="p-4 border-t border-white/5 space-y-2">
                    <button onclick="toggleDarkMode()" class="w-full flex items-center justify-between gap-3 p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-all">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-moon w-5 text-center"></i> <span class="text-sm">Dark Mode</span>
                        </div>
                        <div class="w-8 h-4 rounded-full bg-slate-600 relative">
                            <div class="w-4 h-4 rounded-full bg-white absolute top-0 left-0 transition-all" id="dm-toggle"></div>
                        </div>
                    </button>
                    <button onclick="logout()" class="w-full flex items-center gap-3 p-3 rounded-xl bg-red-500/10 hover:bg-red-500/20 text-red-400 hover:text-red-300 transition-all border border-red-500/20">
                        <i class="fas fa-sign-out-alt w-5 text-center"></i> <span class="text-sm font-bold">Logout</span>
                    </button>
                </div>
            </aside>

            <div class="flex-1 flex flex-col h-full overflow-hidden relative">
                <header class="glass-card border-b border-white/5 p-4 flex items-center justify-between md:justify-end gap-4">
                    <button onclick="toggleSidebar()" class="md:hidden text-slate-300 p-2 hover:bg-white/10 rounded-lg">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center gap-3">
                        <div class="text-right hidden sm:block">
                            <div class="text-xs font-bold text-primary">Online</div>
                            <div class="text-[10px] text-slate-500" id="current-user-display">Loading...</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-900 border border-white/10 flex items-center justify-center text-accent shadow-inner">
                            <i class="fas fa-user-shield"></i>
                        </div>
                    </div>
                </header>

                <main class="flex-1 overflow-y-auto p-4 md:p-8 relative">
                    
                    <!-- DASHBOARD TAB -->
                    <div id="dashboard" class="tab-content active space-y-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="glass-card p-4 rounded-2xl border-l-4 border-emerald-500">
                                <div class="text-slate-400 text-[10px] uppercase font-bold mb-1">Pemasukan</div>
                                <div id="stat-pemasukan" class="text-xl font-bold text-white">Rp 0</div>
                            </div>
                            <div class="glass-card p-4 rounded-2xl border-l-4 border-red-500">
                                <div class="text-slate-400 text-[10px] uppercase font-bold mb-1">Pengeluaran</div>
                                <div id="stat-pengeluaran" class="text-xl font-bold text-white">Rp 0</div>
                            </div>
                            <div class="glass-card p-4 rounded-2xl border-l-4 border-primary">
                                <div class="text-slate-400 text-[10px] uppercase font-bold mb-1">Saldo Bersih</div>
                                <div id="stat-saldo" class="text-xl font-bold text-primary">Rp 0</div>
                            </div>
                            <div class="glass-card p-4 rounded-2xl border-l-4 border-warning">
                                <div class="text-slate-400 text-[10px] uppercase font-bold mb-1">Tunggakan</div>
                                <div id="stat-tunggakan" class="text-xl font-bold text-warning">Rp 0</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 glass-card rounded-2xl p-5">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-sm text-slate-200">Aktivitas Terbaru</h3>
                                    <button onclick="showTab('transactions')" class="text-xs text-primary hover:text-white transition">Lihat Semua</button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-xs text-left">
                                        <thead class="text-slate-400 border-b border-white/5">
                                            <tr>
                                                <th class="py-2">Tanggal</th>
                                                <th class="py-2">Nama</th>
                                                <th class="py-2 text-right">Nominal</th>
                                                <th class="py-2 text-center">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-trans-body" class="text-slate-300"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="glass-card rounded-2xl p-5 flex flex-col items-center justify-center">
                                <h3 class="font-bold text-sm text-slate-200 mb-2 w-full text-left">Pembagian</h3>
                                <div class="w-full h-48 relative">
                                    <canvas id="monthlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TRANSACTIONS TAB -->
                    <div id="transactions" class="tab-content space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="glass-card rounded-2xl p-6 h-fit">
                                <h3 class="font-bold text-lg text-white mb-4">Input Transaksi</h3>
                                <form id="form-transaksi" class="space-y-4">
                                    <select id="t-jenis" onchange="updateDefaultPrice()" class="w-full p-3 rounded-xl bg-white/5 border-white/10">
                                        <option value="pemasukan" class="text-black">Pemasukan (Bayar)</option>
                                        <option value="pengeluaran" class="text-black">Pengeluaran (Tagihan)</option>
                                    </select>
                                    <select id="t-kategori" onchange="updateDefaultPrice()" class="w-full p-3 rounded-xl bg-white/5 border-white/10">
                                        <option value="internet" class="text-black">Internet</option>
                                        <option value="gas" class="text-black">Gas</option>
                                    </select>
                                    <select id="t-pelanggan" onchange="updateDefaultPrice()" class="w-full p-3 rounded-xl bg-white/5 border-white/10 text-slate-300" required>
                                        <option value="">-- Pilih Pelanggan --</option>
                                    </select>
                                    <input type="number" id="t-jumlah" class="w-full p-3 rounded-xl bg-white/5 border-white/10" placeholder="Jumlah (Rp)" min="1" required>
                                    <input type="text" id="t-deskripsi" class="w-full p-3 rounded-xl bg-white/5 border-white/10" placeholder="Deskripsi (opsional)">
                                    <button type="submit" class="w-full bg-primary hover:bg-secondary text-white font-bold py-3 rounded-xl transition shadow-lg shadow-primary/20">Simpan</button>
                                </form>
                            </div>

                            <div class="lg:col-span-2 glass-card rounded-2xl p-6">
                                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                                    <h3 class="font-bold text-lg text-white">Riwayat Transaksi</h3>
                                    <div class="flex gap-2">
                                        <select id="filter-status" onchange="loadTransactions()" class="bg-white/5 border-white/10 rounded-lg p-2 text-xs">
                                            <option value="">Semua Status</option>
                                            <option value="lunas">Lunas</option>
                                            <option value="pending">Pending</option>
                                        </select>
                                        <select id="filter-jenis" onchange="loadTransactions()" class="bg-white/5 border-white/10 rounded-lg p-2 text-xs">
                                            <option value="">Semua Jenis</option>
                                            <option value="pemasukan">Pemasukan</option>
                                            <option value="pengeluaran">Pengeluaran</option>
                                        </select>
                                        <button onclick="exportCSV()" class="bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-2 rounded-lg text-xs">Export CSV</button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto max-h-[500px]">
                                    <table class="w-full text-sm text-left">
                                        <thead class="text-slate-400 bg-white/5 sticky top-0 backdrop-blur-md">
                                            <tr>
                                                <th class="p-3">Tanggal</th>
                                                <th class="p-3">Nama</th>
                                                <th class="p-3">Kategori</th>
                                                <th class="p-3 text-right">Jumlah</th>
                                                <th class="p-3 text-center">Status</th>
                                                <th class="p-3 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="full-trans-body" class="divide-y divide-white/5"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CUSTOMERS TAB -->
                    <div id="customers" class="tab-content space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-bold text-lg text-white mb-4">Tambah Pelanggan</h3>
                                <form id="form-pelanggan" class="space-y-4">
                                    <input type="text" id="p-nama" placeholder="Nama Lengkap" class="w-full p-3 rounded-xl bg-white/5 border-white/10" required>
                                    <div class="grid grid-cols-2 gap-2">
                                        <select id="p-tipe" onchange="toggleCustomerFields()" class="w-full p-3 rounded-xl bg-white/5 border-white/10">
                                            <option value="internet" class="text-black">Internet/PPPoE</option>
                                            <option value="gas" class="text-black">Gas</option>
                                        </select>
                                        <input type="tel" id="p-whatsapp" placeholder="No. WA (08...)" class="w-full p-3 rounded-xl bg-white/5 border-white/10" required>
                                    </div>
                                    <div id="pppoe-fields" class="grid grid-cols-2 gap-2">
                                        <input type="text" id="p-username" placeholder="User PPPoE" class="w-full p-3 rounded-xl bg-white/5 border-white/10">
                                        <input type="text" id="p-password" placeholder="Pass PPPoE" class="w-full p-3 rounded-xl bg-white/5 border-white/10">
                                    </div>
                                    <input type="text" id="p-alamat" placeholder="Alamat (opsional)" class="w-full p-3 rounded-xl bg-white/5 border-white/10">
                                    <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-500/20">Tambah</button>
                                </form>
                            </div>
                            
                            <div class="lg:col-span-2 glass-card rounded-2xl p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-lg text-white">Database Pelanggan</h3>
                                    <input type="text" id="customer-search" onkeyup="loadCustomers()" placeholder="Cari nama..." class="bg-white/5 border-white/10 rounded-lg px-3 py-2 text-sm w-48">
                                </div>
                                <div id="customer-list-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-h-[600px] overflow-y-auto pr-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- WHATSAPP TAB -->
                    <div id="whatsapp" class="tab-content">
                        <div class="max-w-3xl mx-auto glass-card rounded-3xl p-8 border border-white/5">
                            <div class="text-center mb-8">
                                <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-emerald-500 to-green-600 mb-4 shadow-lg shadow-emerald-500/30">
                                    <i class="fab fa-whatsapp text-4xl text-white"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white">WhatsApp Integration</h3>
                                <p class="text-slate-400 text-sm mt-2">Kirim tagihan otomatis ke pelanggan</p>
                            </div>

                            <div class="glass-card rounded-2xl p-6 mb-6 border border-white/5">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div id="wa-status-icon" class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center">
                                            <i class="fas fa-clock text-xl text-slate-400"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm text-slate-400">Status Koneksi</div>
                                            <div id="wa-status-text" class="font-bold text-white">Checking...</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="startWhatsApp()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm font-medium transition">
                                            <i class="fas fa-power-off mr-2"></i>Connect
                                        </button>
                                        <button onclick="stopWhatsApp()" class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm font-medium transition">
                                            <i class="fas fa-plug mr-2"></i>Disconnect
                                        </button>
                                    </div>
                                </div>
                                <div id="wa-qr-info" class="mt-4 p-4 bg-white/5 rounded-xl hidden">
                                    <div class="text-sm text-slate-400 mb-2">
                                        <i class="fas fa-qrcode mr-2"></i>Scan QR Code di terminal server
                                    </div>
                                    <div id="wa-qr-image" class="flex justify-center"></div>
                                    <div class="text-xs text-slate-500 mt-2">
                                        WhatsApp â†’ Menu â†’ Perangkat Tertaut â†’ Tautkan Perangkat
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card rounded-2xl p-6 border border-white/5">
                                <h4 class="font-bold text-white mb-4">
                                    <i class="fas fa-paper-plane mr-2 text-emerald-400"></i>Kirim Pesan
                                </h4>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs text-slate-400 uppercase mb-2">Pilih Pelanggan</label>
                                        <select id="wa-select-customer" onchange="updateWAFromCustomer()" class="w-full p-4 rounded-2xl bg-white/5 border-white/10">
                                            <option value="">-- Kirim ke Semua dengan Tunggakan --</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-xs text-slate-400 uppercase mb-2">Tipe Pesan</label>
                                        <div class="flex gap-2 mb-3">
                                            <button onclick="setTemplate('internet')" id="btn-tpl-internet" class="flex-1 py-2 px-3 rounded-lg text-xs font-medium transition border border-primary bg-primary/20 text-primary">
                                                <i class="fas fa-wifi mr-1"></i> Internet/PPPoE
                                            </button>
                                            <button onclick="setTemplate('gas')" id="btn-tpl-gas" class="flex-1 py-2 px-3 rounded-lg text-xs font-medium transition border border-white/10 bg-white/5 text-slate-400">
                                                <i class="fas fa-fire mr-1"></i> Gas
                                            </button>
                                        </div>
                                        <label class="block text-xs text-slate-400 uppercase mb-2">Template Pesan</label>
                                        <textarea id="wa-msg" rows="6" class="w-full p-4 rounded-2xl bg-white/5 border-white/10 font-mono text-sm" placeholder="Pilih tipe pelanggan untuk melihat template..."></textarea>
                                        <p class="text-[10px] text-slate-500 mt-2">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Variabel: {nama}, {jumlah}, {tipe}, {tanggal}, {periode}
                                        </p>
                                    </div>

                                    <button onclick="sendWA()" class="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:opacity-90 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-500/20 transition transform active:scale-95">
                                        <i class="fab fa-whatsapp mr-2"></i>Kirim Pesan
                                    </button>
                                </div>
                            </div>

                            <div id="wa-broadcast-stats" class="mt-6 glass-card rounded-2xl p-6 border border-emerald-500/20 hidden">
                                <h4 class="font-bold text-white mb-4">
                                    <i class="fas fa-chart-bar mr-2 text-emerald-400"></i>Hasil Broadcast
                                </h4>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="text-center p-4 bg-white/5 rounded-xl">
                                        <div id="wa-total-sent" class="text-2xl font-bold text-white">0</div>
                                        <div class="text-xs text-slate-400">Total</div>
                                    </div>
                                    <div class="text-center p-4 bg-emerald-500/10 rounded-xl">
                                        <div id="wa-success-sent" class="text-2xl font-bold text-emerald-400">0</div>
                                        <div class="text-xs text-slate-400">Berhasil</div>
                                    </div>
                                    <div class="text-center p-4 bg-red-500/10 rounded-xl">
                                        <div id="wa-failed-sent" class="text-2xl font-bold text-red-400">0</div>
                                        <div class="text-xs text-slate-400">Gagal</div>
                                    </div>
                                </div>
                            </div>

                            <div id="wa-preview" class="mt-6 glass-card rounded-2xl p-6 border border-white/5">
                                <h4 class="font-bold text-white mb-4">
                                    <i class="fas fa-eye mr-2 text-accent"></i>Preview Pesan
                                </h4>
                                <div id="wa-preview-content" class="bg-black/30 rounded-xl p-4 font-mono text-xs text-slate-300 whitespace-pre-wrap leading-relaxed max-h-64 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>

                    <!-- REPORTS TAB -->
                    <div id="reports" class="tab-content space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-bold text-lg text-white mb-4">Manajemen Data</h3>
                                <div class="space-y-3">
                                    <button onclick="exportCSV()" class="w-full bg-blue-500/20 text-blue-300 border border-blue-500/30 hover:bg-blue-500/30 py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                                        <i class="fas fa-file-csv"></i> Export CSV
                                    </button>
                                    <button onclick="exportJSON()" class="w-full bg-purple-500/20 text-purple-300 border border-purple-500/30 hover:bg-purple-500/30 py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                                        <i class="fas fa-file-code"></i> Backup JSON
                                    </button>
                                    <div class="pt-4 border-t border-white/10">
                                        <label class="block text-xs text-slate-400 mb-2">Restore Backup (Admin)</label>
                                        <div class="flex gap-2">
                                            <input type="file" id="restore-file" accept=".json" class="flex-1 p-2 rounded-lg bg-white/5 border-white/10 text-sm">
                                            <button onclick="restoreData()" class="bg-green-500 hover:bg-green-600 text-white px-4 rounded-lg">Load</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-bold text-lg text-white mb-4">Visualisasi Tahunan</h3>
                                <div class="h-64 relative">
                                    <canvas id="yearlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SETTINGS TAB (Admin Only) -->
                    <div id="settings" class="tab-content">
                        <div class="max-w-md mx-auto glass-card rounded-3xl p-8">
                            <h3 class="font-bold text-xl text-white mb-6">Konfigurasi Sistem</h3>
                            <div class="space-y-5">
                                <div>
                                    <label class="text-xs text-slate-400 uppercase">Harga Tagihan Internet</label>
                                    <input type="number" id="s-price-net" class="w-full p-3 mt-1 rounded-xl bg-white/5 border-white/10" value="150000">
                                    <p class="text-[10px] text-slate-500 mt-1">Harga default untuk tagihan pelanggan PPPoE/Internet</p>
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400 uppercase">Harga Penjualan Gas</label>
                                    <input type="number" id="s-price-gas" class="w-full p-3 mt-1 rounded-xl bg-white/5 border-white/10" value="22000">
                                    <p class="text-[10px] text-slate-500 mt-1">Harga default untuk faktur pelanggan Gas</p>
                                </div>
                                <button onclick="saveSettings()" class="w-full bg-primary hover:bg-secondary text-white font-bold py-3 rounded-xl">Simpan</button>
                                
                                <div class="pt-6 mt-6 border-t border-white/10">
                                    <h4 class="text-xs font-bold text-red-400 uppercase mb-3">Danger Zone</h4>
                                    <button onclick="resetSystem()" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/30 py-3 rounded-xl font-bold">
                                        Reset Database
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- USERS MANAGEMENT TAB (Admin Only) -->
                    <div id="users" class="tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-bold text-lg text-white mb-4">Tambah User</h3>
                                <form id="form-user" class="space-y-4">
                                    <input type="text" id="u-username" placeholder="Username" class="w-full p-3 rounded-xl bg-white/5 border-white/10" required>
                                    <input type="password" id="u-password" placeholder="Password" class="w-full p-3 rounded-xl bg-white/5 border-white/10" required>
                                    <input type="text" id="u-nama" placeholder="Nama Lengkap" class="w-full p-3 rounded-xl bg-white/5 border-white/10" required>
                                    <select id="u-role" class="w-full p-3 rounded-xl bg-white/5 border-white/10">
                                        <option value="staff" class="text-black">Staff</option>
                                        <option value="admin" class="text-black">Admin</option>
                                    </select>
                                    <button type="submit" class="w-full bg-primary hover:bg-secondary text-white font-bold py-3 rounded-xl">Tambah User</button>
                                </form>
                            </div>
                            
                            <div class="lg:col-span-2 glass-card rounded-2xl p-6">
                                <h3 class="font-bold text-lg text-white mb-4">Daftar User</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead class="text-slate-400 bg-white/5">
                                            <tr>
                                                <th class="p-3">Username</th>
                                                <th class="p-3">Nama</th>
                                                <th class="p-3">Role</th>
                                                <th class="p-3">Status</th>
                                                <th class="p-3 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="users-list-body" class="divide-y divide-white/5"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </main>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const API_URL = '';
        let apiToken = localStorage.getItem('apiToken');
        let currentUser = null;
        let chartInstance = null;
        let yearChartInstance = null;
        let waStatusInterval = null;
        let currentTemplateType = 'internet';
        let selectedCustomerForWA = null;

        // WhatsApp Templates (Tanpa Username/Password)
        const WA_TEMPLATES = {
            internet: `ðŸ  *NOTIFIKASI TAGIHAN INTERNET*

Halo {nama}!

Berikut adalah detail tagihan layanan internet Anda:

ðŸ“… Periode : {periode}

ðŸ’° *Total Tagihan: Rp {jumlah}*

Mohon segera lakukan pembayaran agar layanan tetap aktif.

Terima kasih! ðŸ™

* BillingPro - Smart Management *`,

            gas: `ðŸ”¥ *FAKTUR PENJUALAN GAS*

Halo {nama}!

ðŸ“… Tanggal : {tanggal}
â›½ Jenis   : Gas {tipe}

ðŸ’° *Total Pembayaran: Rp {jumlah}*

Silakan lakukan pembayaran sesuai nominal di atas.

Hormat kami,
* BillingPro - Smart Management *`
        };

        // ==================== API FUNCTIONS ====================
        async function apiCall(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (apiToken) headers['Authorization'] = `Bearer ${apiToken}`;
            
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const res = await fetch(`${API_URL}${endpoint}`, options);
                const data = await res.json();
                
                if (!res.ok && res.status === 401) {
                    logout();
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }

        // ==================== UI HELPERS ====================
        function showToast(msg, type = 'info') {
            const el = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const txt = document.getElementById('toast-msg');
            
            const colors = { success: 'bg-emerald-500', error: 'bg-red-500', info: 'bg-blue-500', warning: 'bg-orange-500' };
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle', warning: 'fa-bell' };
            
            el.className = `fixed bottom-5 right-5 z-[100] min-w-[250px] px-4 py-3 rounded-xl shadow-xl transform transition-all duration-300 font-medium text-sm flex items-center gap-3 ${colors[type]} text-white`;
            icon.className = `fas ${icons[type]}`;
            txt.innerText = msg;

            requestAnimationFrame(() => el.classList.remove('translate-y-20', 'opacity-0'));
            setTimeout(() => el.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function formatIDR(num) {
            if (!num) return 'Rp 0';
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        }

        // ==================== AUTHENTICATION ====================
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-user').value;
            const password = document.getElementById('login-pass').value;
            
            const res = await apiCall('/api/auth/login', 'POST', { username, password });
            
            if (res.success) {
                apiToken = res.token;
                currentUser = res.user;
                localStorage.setItem('apiToken', apiToken);
                sessionStorage.setItem('isLoggedIn', 'true');
                initApp();
            } else {
                const card = e.target.closest('.glass-card');
                card.classList.add('animate-pulse', 'border-red-500');
                setTimeout(() => card.classList.remove('animate-pulse', 'border-red-500'), 500);
                showToast(res.error || 'Login gagal', 'error');
            }
        });

        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                sessionStorage.removeItem('isLoggedIn');
                localStorage.removeItem('apiToken');
                currentUser = null;
                apiToken = null;
                location.reload();
            }
        }

        function startClock() {
            const clockEl = document.getElementById('live-clock');
            const dateEl = document.getElementById('live-date');
            
            function update() {
                const now = new Date();
                clockEl.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                if (dateEl) {
                    dateEl.textContent = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' });
                }
            }
            update();
            setInterval(update, 1000);
        }

        // ==================== SSE CONNECTION ====================
        function connectSSE() {
            const evtSource = new EventSource('/api/events');
            
            evtSource.onmessage = (e) => {
                const data = JSON.parse(e.data);
                
                if (data.type === 'wa_status') {
                    updateWAStatusUI(data.data);
                } else if (data.type === 'wa_qr') {
                    showQRCode(data.data);
                } else if (['transaction_updated', 'customer_updated', 'settings_updated'].includes(data.type)) {
                    // Refresh data when updates come from other users
                    renderAll();
                }
            };
            
            evtSource.onerror = () => {
                console.log('SSE connection lost, retrying...');
            };
        }

        // ==================== INIT ====================
        async function initApp() {
            if (sessionStorage.getItem('isLoggedIn') !== 'true' || !apiToken) {
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
                return;
            }

            // Verify token
            const verifyRes = await apiCall('/api/auth/verify');
            if (!verifyRes.success) {
                logout();
                return;
            }

            currentUser = verifyRes.user;

            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');

            // Update UI with user info
            document.getElementById('user-role-display').textContent = `${currentUser.nama_lengkap} (${currentUser.role.toUpperCase()})`;
            document.getElementById('current-user-display').textContent = currentUser.nama_lengkap;

            // Show admin-only features
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
            }

            startClock();
            connectSSE();
            
            await Promise.all([
                loadSettings(),
                renderAll()
            ]);

            setTemplate('internet');
            checkWAStatus();
        }

        // ==================== SIDEBAR ====================
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        // ==================== NAVIGATION ====================
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => {
                el.classList.remove('bg-white/10', 'text-white', 'border-l-4', 'border-primary');
                el.classList.add('text-slate-300');
            });

            document.getElementById(tabId).classList.add('active');
            
            const btn = document.querySelector(`button[onclick="showTab('${tabId}')"]`);
            if (btn) {
                btn.classList.add('bg-white/10', 'text-white', 'border-l-4', 'border-primary');
                btn.classList.remove('text-slate-300');
            }

            if (window.innerWidth < 768) toggleSidebar();

            if (tabId === 'reports') renderYearlyChart();
            if (tabId === 'users') loadUsers();
            if (tabId === 'whatsapp') {
                updateMessagePreview();
                updatePendingStats();
            }
        }

        // ==================== DATA LOADING ====================
        async function loadSettings() {
            const res = await apiCall('/api/settings');
            if (res.success) {
                if (res.data.price_internet) document.getElementById('s-price-net').value = res.data.price_internet;
                if (res.data.price_gas) document.getElementById('s-price-gas').value = res.data.price_gas;
            }
        }

        async function renderAll() {
            await Promise.all([
                loadStats(),
                loadTransactions(),
                loadCustomers(),
                updateSelects()
            ]);
        }

        async function loadStats() {
            const res = await apiCall('/api/transactions/stats');
            if (res.success) {
                document.getElementById('stat-pemasukan').innerText = formatIDR(res.data.income);
                document.getElementById('stat-pengeluaran').innerText = formatIDR(res.data.expense);
                document.getElementById('stat-saldo').innerText = formatIDR(res.data.balance);
                document.getElementById('stat-tunggakan').innerText = formatIDR(res.data.pending);
            }

            // Chart
            const ctx = document.getElementById('monthlyChart')?.getContext('2d');
            if (ctx) {
                if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pemasukan', 'Pengeluaran'],
                        datasets: [{
                            data: [res.data?.income || 0, res.data?.expense || 0],
                            backgroundColor: ['#10b981', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        cutout: '70%'
                    }
                });
            }
        }

        async function loadTransactions() {
            const statusFilter = document.getElementById('filter-status')?.value || '';
            const jenisFilter = document.getElementById('filter-jenis')?.value || '';
            
            let url = '/api/transactions?';
            if (statusFilter) url += `status=${statusFilter}&`;
            if (jenisFilter) url += `jenis=${jenisFilter}`;
            
            const res = await apiCall(url);
            if (!res.success) return;

            // Recent transactions
            const recentBody = document.getElementById('recent-trans-body');
            if (recentBody) {
                const recent = res.data.slice(0, 5);
                recentBody.innerHTML = recent.map(t => `
                    <tr class="border-b border-white/5 last:border-0 hover:bg-white/5">
                        <td class="py-3 text-slate-400">${new Date(t.created_at).toLocaleDateString()}</td>
                        <td class="py-3">${t.customer_nama}</td>
                        <td class="py-3 text-right font-mono ${t.jenis === 'pemasukan' ? 'text-emerald-400' : 'text-red-400'}">${formatIDR(t.jumlah)}</td>
                        <td class="py-3 text-center"><span class="px-2 py-1 rounded bg-white/10 text-[10px] uppercase ${t.status === 'lunas' ? 'text-emerald-400' : 'text-orange-400'}">${t.status}</span></td>
                    </tr>
                `).join('');
            }

            // Full transactions
            const fullBody = document.getElementById('full-trans-body');
            if (fullBody) {
                fullBody.innerHTML = res.data.map(t => `
                    <tr class="hover:bg-white/5">
                        <td class="p-3 text-slate-400 text-xs">${new Date(t.created_at).toLocaleDateString()}</td>
                        <td class="p-3 font-medium">${t.customer_nama}<br><span class="text-[10px] text-slate-500">${t.kategori}</span></td>
                        <td class="p-3 text-xs capitalize">${t.kategori}</td>
                        <td class="p-3 font-mono text-right ${t.jenis === 'pemasukan' ? 'text-emerald-400' : 'text-red-400'}">${formatIDR(t.jumlah)}</td>
                        <td class="p-3 text-center"><span class="text-xs uppercase ${t.status === 'lunas' ? 'text-emerald-400' : 'text-orange-400'}">${t.status}</span></td>
                        <td class="p-3 text-center space-x-1">
                            ${t.status === 'pending' ? `<button onclick="markLunas(${t.id})" class="text-emerald-400 hover:bg-emerald-400/20 p-2 rounded"><i class="fas fa-check"></i></button>` : ''}
                            <button onclick="delTrans(${t.id})" class="text-red-400 hover:bg-red-400/20 p-2 rounded"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function loadCustomers() {
            const res = await apiCall('/api/customers');
            if (!res.success) return;

            const search = document.getElementById('customer-search')?.value.toLowerCase() || '';
            const filtered = res.data.filter(c => c.nama.toLowerCase().includes(search));

            const cList = document.getElementById('customer-list-container');
            if (cList) {
                cList.innerHTML = filtered.map(c => `
                    <div class="bg-white/5 rounded-xl p-4 border border-white/5 flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-white">${c.nama}</span>
                                <span class="text-[9px] px-2 py-0.5 rounded ${c.tipe === 'internet' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'} uppercase">${c.tipe}</span>
                            </div>
                            <div class="text-xs text-slate-400 mt-1"><i class="fab fa-whatsapp"></i> ${c.whatsapp}</div>
                            ${c.tipe === 'internet' ? `<div class="text-[10px] font-mono text-slate-500 mt-2 bg-black/20 p-1 rounded inline-block">U:${c.username_pppoe || '-'} P:${c.password_pppoe || '-'}</div>` : ''}
                        </div>
                        <button onclick="delCustomer(${c.id})" class="text-slate-500 hover:text-red-400 ml-2"><i class="fas fa-user-times"></i></button>
                    </div>
                `).join('');
            }
        }

        async function updateSelects() {
            const res = await apiCall('/api/customers');
            if (!res.success) return;

            const selects = ['t-pelanggan', 'wa-select-customer'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const val = el.value;
                    el.innerHTML = `<option value="">${id === 'wa-select-customer' ? '-- Kirim ke Semua dengan Tunggakan --' : '-- Pilih --'}</option>` + 
                        res.data.map(c => `<option value="${c.id}">${c.nama} (${c.tipe})</option>`).join('');
                    el.value = val;
                }
            });
        }

        // ==================== TRANSACTIONS ====================
        function updateDefaultPrice() {
            const custId = document.getElementById('t-pelanggan').value;
            const cat = document.getElementById('t-kategori').value;
            const type = document.getElementById('t-jenis').value;
            const input = document.getElementById('t-jumlah');
            
            const priceInternet = document.getElementById('s-price-net').value;
            const priceGas = document.getElementById('s-price-gas').value;

            if (custId) {
                const res = apiCall(`/api/customers/${custId}`).then(r => {
                    if (r.success && r.data) {
                        const customer = r.data;
                        if (type === 'pemasukan') {
                            input.value = customer.tipe === 'internet' ? priceInternet : priceGas;
                            document.getElementById('t-kategori').value = customer.tipe;
                        }
                    }
                });
            } else if (type === 'pemasukan') {
                input.value = cat === 'internet' ? priceInternet : priceGas;
            } else {
                input.value = '';
            }
        }

        document.getElementById('form-transaksi').addEventListener('submit', async (e) => {
            e.preventDefault();
            const custId = document.getElementById('t-pelanggan').value;
            const jumlah = document.getElementById('t-jumlah').value;
            const jenis = document.getElementById('t-jenis').value;
            const kategori = document.getElementById('t-kategori').value;
            const deskripsi = document.getElementById('t-deskripsi').value;

            if (!custId) return showToast('Pilih customer dulu!', 'warning');

            const custRes = await apiCall(`/api/customers/${custId}`);
            const customer = custRes.success ? custRes.data : { nama: 'Unknown', tipe: kategori };

            const res = await apiCall('/api/transactions', 'POST', {
                customer_id: parseInt(custId),
                customer_nama: customer.nama,
                customer_tipe: customer.tipe,
                kategori,
                jumlah: parseInt(jumlah),
                jenis,
                status: jenis === 'pemasukan' ? 'lunas' : 'pending',
                deskripsi
            });

            if (res.success) {
                showToast('Transaksi Tersimpan', 'success');
                e.target.reset();
                await renderAll();
            } else {
                showToast(res.error || 'Gagal', 'error');
            }
        });

        async function markLunas(id) {
            const res = await apiCall(`/api/transactions/${id}/mark-lunas`, 'POST');
            if (res.success) {
                showToast('Tagihan Dibayar', 'success');
                await renderAll();
            }
        }

        async function delTrans(id) {
            if (!confirm('Hapus transaksi?')) return;
            const res = await apiCall(`/api/transactions/${id}`, 'DELETE');
            if (res.success) {
                showToast('Transaksi Dihapus', 'info');
                await renderAll();
            }
        }

        // ==================== CUSTOMERS ====================
        function toggleCustomerFields() {
            const t = document.getElementById('p-tipe').value;
            document.getElementById('pppoe-fields').style.display = t === 'internet' ? 'grid' : 'none';
        }

        document.getElementById('form-pelanggan').addEventListener('submit', async (e) => {
            e.preventDefault();
            const wa = document.getElementById('p-whatsapp').value.trim();
            
            if (!/^08\d{8,11}$/.test(wa)) {
                showToast('Format WhatsApp salah (08xx...)', 'error');
                return;
            }

            const res = await apiCall('/api/customers', 'POST', {
                nama: document.getElementById('p-nama').value.trim(),
                tipe: document.getElementById('p-tipe').value,
                whatsapp: wa,
                username_pppoe: document.getElementById('p-username').value.trim(),
                password_pppoe: document.getElementById('p-password').value.trim(),
                alamat: document.getElementById('p-alamat').value.trim()
            });

            if (res.success) {
                showToast('Pelanggan Ditambahkan', 'success');
                e.target.reset();
                toggleCustomerFields();
                await renderAll();
            } else {
                showToast(res.error || 'Gagal', 'error');
            }
        });

        async function delCustomer(id) {
            if (!confirm('Hapus pelanggan?')) return;
            const res = await apiCall(`/api/customers/${id}`, 'DELETE');
            if (res.success) {
                showToast('Pelanggan Dihapus', 'info');
                await renderAll();
            }
        }

        // ==================== WHATSAPP ====================
        function setTemplate(type) {
            currentTemplateType = type;
            
            const btnInternet = document.getElementById('btn-tpl-internet');
            const btnGas = document.getElementById('btn-tpl-gas');
            
            if (type === 'internet') {
                btnInternet.className = 'flex-1 py-2 px-3 rounded-lg text-xs font-medium transition border border-primary bg-primary/20 text-primary';
                btnGas.className = 'flex-1 py-2 px-3 rounded-lg text-xs font-medium transition border border-white/10 bg-white/5 text-slate-400';
            } else {
                btnInternet.className = 'flex-1 py-2 px-3 rounded-lg text-xs font-medium transition border border-white/10 bg-white/5 text-slate-400';
                btnGas.className = 'flex-1 py-2 px-3 rounded-lg text-xs font-medium transition border border-primary bg-primary/20 text-primary';
            }
            
            document.getElementById('wa-msg').value = WA_TEMPLATES[type];
            updateMessagePreview();
        }

        async function updateTemplateByCustomer() {
            const custId = document.getElementById('wa-select-customer').value;
            if (!custId) {
                setTemplate('internet');
                return;
            }
            
            const res = await apiCall(`/api/customers/${custId}`);
            if (res.success && res.data) {
                setTemplate(res.data.tipe);
                selectedCustomerForWA = res.data;
            }
        }

        async function updateWAFromCustomer() {
            await updateTemplateByCustomer();
            updateMessagePreview();
        }

        function formatMessage(template, customer, amount) {
            const period = new Date().toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

            return template
                .replace(/\{nama\}/g, customer.nama || 'Pelanggan')
                .replace(/\{jumlah\}/g, amount.toLocaleString('id-ID'))
                .replace(/\{tipe\}/g, customer.tipe === 'internet' ? 'Internet/PPPoE' : 'LPG 3kg')
                .replace(/\{tanggal\}/g, today)
                .replace(/\{periode\}/g, period);
        }

        async function updateMessagePreview() {
            const preview = document.getElementById('wa-preview-content');
            const template = document.getElementById('wa-msg').value;
            const custId = document.getElementById('wa-select-customer').value;
            
            let previewText = template;
            
            if (custId) {
                const res = await apiCall(`/api/customers/${custId}`);
                if (res.success && res.data) {
                    const pendingRes = await apiCall(`/api/transactions/customer/${custId}/pending`);
                    const amount = pendingRes.success ? pendingRes.total : 0;
                    previewText = formatMessage(template, res.data, amount);
                }
            } else {
                const exampleCustomer = { nama: 'Nama Pelanggan', tipe: currentTemplateType, username_pppoe: 'user123', password_pppoe: 'pass456' };
                previewText = formatMessage(template, exampleCustomer, 150000);
            }
            
            if (preview) preview.textContent = previewText;
        }

        async function updatePendingStats() {
            const res = await apiCall('/api/customers/with-pending/debt');
            if (!res.success) return;
            
            let internet = 0, gas = 0;
            res.data.forEach(c => {
                if (c.tipe === 'internet') internet += parseInt(c.total_debt);
                else gas += parseInt(c.total_debt);
            });
            
            // Update pending stats display if needed
        }

        async function checkWAStatus() {
            const res = await apiCall('/api/whatsapp/status');
            if (res.success) {
                updateWAStatusUI(res.data);
            }
        }

        function updateWAStatusUI(data) {
            const icon = document.getElementById('wa-status-icon');
            const text = document.getElementById('wa-status-text');
            const qrInfo = document.getElementById('wa-qr-info');
            
            switch (data.status) {
                case 'ready':
                    icon.className = 'w-12 h-12 rounded-full bg-emerald-500 flex items-center justify-center';
                    icon.innerHTML = '<i class="fas fa-check text-xl text-white"></i>';
                    text.className = 'font-bold text-emerald-400';
                    text.innerText = 'Connected & Ready';
                    qrInfo.classList.add('hidden');
                    break;
                case 'qr':
                    icon.className = 'w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center animate-pulse';
                    icon.innerHTML = '<i class="fas fa-qrcode text-xl text-white"></i>';
                    text.className = 'font-bold text-blue-400';
                    text.innerText = 'Scan QR Code';
                    qrInfo.classList.remove('hidden');
                    break;
                case 'authenticated':
                    icon.className = 'w-12 h-12 rounded-full bg-yellow-500 flex items-center justify-center';
                    icon.innerHTML = '<i class="fas fa-spinner text-xl text-white animate-spin"></i>';
                    text.className = 'font-bold text-yellow-400';
                    text.innerText = 'Authenticating...';
                    qrInfo.classList.add('hidden');
                    break;
                default:
                    icon.className = 'w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center';
                    icon.innerHTML = '<i class="fas fa-clock text-xl text-slate-400"></i>';
                    text.className = 'font-bold text-slate-400';
                    text.innerText = 'Disconnected';
                    qrInfo.classList.add('hidden');
            }
        }

        function showQRCode(qrData) {
            const container = document.getElementById('wa-qr-image');
            if (container && qrData) {
                container.innerHTML = `<img src="${qrData}" class="w-48 h-48" alt="QR Code">`;
            }
        }

        async function startWhatsApp() {
            showToast('Memulai WhatsApp Service...', 'info');
            const res = await apiCall('/api/whatsapp/start', 'POST');
            if (res.success) {
                showToast('Service dimulai. Scan QR Code!', 'success');
            } else {
                showToast('Gagal: ' + res.error, 'error');
            }
        }

        async function stopWhatsApp() {
            if (!confirm('Disconnect WhatsApp?')) return;
            const res = await apiCall('/api/whatsapp/stop', 'POST');
            if (res.success) {
                showToast('Disconnected', 'info');
            }
        }

        async function sendWA() {
            const custId = document.getElementById('wa-select-customer').value;
            const template = document.getElementById('wa-msg').value;
            
            if (custId) {
                const res = await apiCall('/api/whatsapp/send-billing', 'POST', {
                    customerId: parseInt(custId),
                    template
                });
                
                if (res.success) {
                    showToast('Pesan terkirim ke ' + res.customer, 'success');
                } else {
                    showToast('Gagal: ' + res.error, 'error');
                }
            } else {
                if (!confirm('Kirim ke SEMUA pelanggan dengan tunggakan?')) return;
                showToast('Mengirim broadcast...', 'info');
                const res = await apiCall('/api/whatsapp/broadcast', 'POST', { template });
                
                if (res.success) {
                    showToast(res.message, 'success');
                    const stats = document.getElementById('wa-broadcast-stats');
                    stats.classList.remove('hidden');
                    document.getElementById('wa-total-sent').innerText = res.summary.total;
                    document.getElementById('wa-success-sent').innerText = res.summary.success;
                    document.getElementById('wa-failed-sent').innerText = res.summary.failed;
                } else {
                    showToast('Gagal: ' + res.error, 'error');
                }
            }
        }

        // ==================== REPORTS ====================
        async function renderYearlyChart() {
            const res = await apiCall('/api/transactions/monthly');
            if (!res.success) return;
            
            const ctx = document.getElementById('yearlyChart')?.getContext('2d');
            if (!ctx) return;
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            const inData = new Array(12).fill(0);
            const outData = new Array(12).fill(0);
            
            res.data.forEach(d => {
                const m = parseInt(d.month) - 1;
                inData[m] = d.income || 0;
                outData[m] = d.expense || 0;
            });
            
            if (yearChartInstance) yearChartInstance.destroy();
            yearChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        { label: 'Pemasukan', data: inData, backgroundColor: '#10b981', borderRadius: 4 },
                        { label: 'Pengeluaran', data: outData, backgroundColor: '#ef4444', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    },
                    plugins: { legend: { labels: { color: '#cbd5e1' } } }
                }
            });
        }

        async function exportCSV() {
            const res = await apiCall('/api/transactions');
            if (!res.success || !res.data.length) return showToast('Data Kosong', 'warning');
            
            let csv = 'Tanggal,Nama,Kategori,Jenis,Jumlah,Status\n';
            res.data.forEach(t => {
                csv += `${new Date(t.created_at).toLocaleDateString()},"${t.customer_nama}","${t.kategori}",${t.jenis},${t.jumlah},${t.status}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = window.URL.createObjectURL(blob);
            a.download = `Billing_${Date.now()}.csv`;
            a.click();
        }

        async function exportJSON() {
            const res = await apiCall('/api/backup');
            if (!res.success) return showToast('Gagal', 'error');
            
            const blob = new Blob([JSON.stringify(res, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = window.URL.createObjectURL(blob);
            a.download = `Backup_${Date.now()}.json`;
            a.click();
        }

        async function restoreData() {
            const file = document.getElementById('restore-file').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const res = await apiCall('/api/restore', 'POST', data);
                    if (res.success) {
                        showToast('Data Dipulihkan', 'success');
                        setTimeout(() => location.reload(), 1000);
                    }
                } catch (err) {
                    showToast('File Invalid', 'error');
                }
            };
            reader.readAsText(file);
        }

        // ==================== SETTINGS ====================
        async function saveSettings() {
            const internet = document.getElementById('s-price-net').value;
            const gas = document.getElementById('s-price-gas').value;
            
            await apiCall('/api/settings', 'POST', { key: 'price_internet', value: internet });
            await apiCall('/api/settings', 'POST', { key: 'price_gas', value: gas });
            
            showToast('Pengaturan Disimpan', 'success');
        }

        async function resetSystem() {
            if (!confirm('Hapus SEMUA data? TIDAK BISA DIBALIKKAN!')) return;
            
            localStorage.clear();
            showToast('Silakan restart server', 'info');
            setTimeout(() => location.reload(), 2000);
        }

        // ==================== USER MANAGEMENT ====================
        async function loadUsers() {
            const res = await apiCall('/api/users');
            if (!res.success) return;
            
            const tbody = document.getElementById('users-list-body');
            if (tbody) {
                tbody.innerHTML = res.data.map(u => `
                    <tr class="hover:bg-white/5">
                        <td class="p-3 font-medium">${u.username}</td>
                        <td class="p-3">${u.nama_lengkap}</td>
                        <td class="p-3"><span class="text-xs uppercase ${u.role === 'admin' ? 'text-purple-400' : 'text-blue-400'}">${u.role}</span></td>
                        <td class="p-3"><span class="text-xs ${u.aktif ? 'text-emerald-400' : 'text-red-400'}">${u.aktif ? 'Aktif' : 'Nonaktif'}</span></td>
                        <td class="p-3 text-center space-x-1">
                            ${u.id !== currentUser.id ? `<button onclick="toggleUserStatus(${u.id}, ${u.aktif ? 0 : 1})" class="text-xs px-2 py-1 rounded ${u.aktif ? 'bg-red-500/20 text-red-400' : 'bg-emerald-500/20 text-emerald-400'}">${u.aktif ? 'Nonaktifkan' : 'Aktifkan'}</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            }
        }

        document.getElementById('form-user').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const res = await apiCall('/api/users', 'POST', {
                username: document.getElementById('u-username').value,
                password: document.getElementById('u-password').value,
                nama_lengkap: document.getElementById('u-nama').value,
                role: document.getElementById('u-role').value
            });
            
            if (res.success) {
                showToast('User Ditambahkan', 'success');
                e.target.reset();
                loadUsers();
            } else {
                showToast(res.error || 'Gagal', 'error');
            }
        });

        async function toggleUserStatus(id, status) {
            const res = await apiCall(`/api/users/${id}`, 'PUT', { aktif: status });
            if (res.success) {
                showToast('Status User Diubah', 'success');
                loadUsers();
            }
        }

        // ==================== DARK MODE ====================
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('pppoe_dark', isDark);
            const dot = document.getElementById('dm-toggle');
            if (isDark) dot.classList.add('translate-x-4');
            else dot.classList.remove('translate-x-4');
        }

        // ==================== INIT ====================
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('pppoe_dark') === 'true') {
                document.documentElement.classList.add('dark');
                document.getElementById('dm-toggle').classList.add('translate-x-4');
            }
            initApp();
        });
    </script>
</body>
</html>
